<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>kmeans: kmeans/InitializeVariancePartition.hpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">kmeans
   </div>
   <div id="projectbrief">A C++ library for k-means</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_b4cd1770f3f86b4e7b02a49a44470eac.html">kmeans</a></li>  </ul>
</div>
</div><!-- top -->
<div id="doc-content">
<div class="header">
  <div class="headertitle"><div class="title">InitializeVariancePartition.hpp</div></div>
</div><!--header-->
<div class="contents">
<a href="InitializeVariancePartition_8hpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span><span class="preprocessor">#ifndef KMEANS_INITIALIZE_VARIANCE_PARTITION_HPP</span></div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span><span class="preprocessor">#define KMEANS_INITIALIZE_VARIANCE_PARTITION_HPP</span></div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span> </div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span><span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span><span class="preprocessor">#include &lt;algorithm&gt;</span></div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span><span class="preprocessor">#include &lt;numeric&gt;</span></div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span><span class="preprocessor">#include &lt;queue&gt;</span></div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span><span class="preprocessor">#include &lt;cstddef&gt;</span></div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span> </div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span><span class="preprocessor">#include &quot;sanisizer/sanisizer.hpp&quot;</span></div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span> </div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span><span class="preprocessor">#include &quot;<a class="code" href="Initialize_8hpp.html">Initialize.hpp</a>&quot;</span></div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span><span class="preprocessor">#include &quot;<a class="code" href="Matrix_8hpp.html">Matrix.hpp</a>&quot;</span></div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span> </div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span><span class="keyword">namespace </span><a class="code hl_namespace" href="namespacekmeans.html">kmeans</a> {</div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span> </div>
<div class="foldopen" id="foldopen00025" data-start="{" data-end="};">
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno"><a class="line" href="structkmeans_1_1InitializeVariancePartitionOptions.html">   25</a></span><span class="keyword">struct </span><a class="code hl_struct" href="structkmeans_1_1InitializeVariancePartitionOptions.html">InitializeVariancePartitionOptions</a> {</div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno"><a class="line" href="structkmeans_1_1InitializeVariancePartitionOptions.html#a1fdbf82af2a33a26c4e58382797454c9">   30</a></span>    <span class="keywordtype">double</span> <a class="code hl_variable" href="structkmeans_1_1InitializeVariancePartitionOptions.html#a1fdbf82af2a33a26c4e58382797454c9">size_adjustment</a> = 1;</div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span> </div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno"><a class="line" href="structkmeans_1_1InitializeVariancePartitionOptions.html#a13e076c3b829ab3664a83a8f1d3b8bfc">   36</a></span>    <span class="keywordtype">bool</span> <a class="code hl_variable" href="structkmeans_1_1InitializeVariancePartitionOptions.html#a13e076c3b829ab3664a83a8f1d3b8bfc">optimize_partition</a> = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span>};</div>
</div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span> </div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span><span class="keyword">namespace </span>InitializeVariancePartition_internal {</div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span> </div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno">   44</span><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Float_&gt;</div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span><span class="keywordtype">void</span> compute_welford(<span class="keyword">const</span> Float_ val, Float_&amp; center, Float_&amp; ss, <span class="keyword">const</span> Float_ count) {</div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno">   46</span>    <span class="keyword">const</span> <span class="keyword">auto</span> cur_center = center;</div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span>    <span class="keyword">const</span> Float_ delta = val - cur_center;</div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span>    <span class="keyword">const</span> Float_ new_center = cur_center + delta / count;</div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span>    center = new_center;</div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span>    ss += (val - new_center) * delta;</div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span>}</div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno">   52</span> </div>
<div class="line"><a id="l00053" name="l00053"></a><span class="lineno">   53</span><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Data_, <span class="keyword">typename</span> Float_&gt;</div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno">   54</span><span class="keywordtype">void</span> compute_welford(<span class="keyword">const</span> std::size_t ndim, <span class="keyword">const</span> Data_* <span class="keyword">const</span> dptr, Float_* <span class="keyword">const</span> center, Float_* <span class="keyword">const</span> dim_ss, <span class="keyword">const</span> Float_ count) {</div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span>    <span class="keywordflow">for</span> (<span class="keyword">decltype</span>(I(ndim)) d = 0; d &lt; ndim; ++d) {</div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno">   56</span>        compute_welford&lt;Float_&gt;(dptr[d], center[d], dim_ss[d], count);</div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span>    }</div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span>}</div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span> </div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Matrix_, <span class="keyword">typename</span> Index_, <span class="keyword">typename</span> Float_&gt;</div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno">   61</span>Float_ optimize_partition(</div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno">   62</span>    <span class="keyword">const</span> Matrix_&amp; data,</div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span>    <span class="keyword">const</span> std::vector&lt;Index_&gt;&amp; current,</div>
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno">   64</span>    <span class="keyword">const</span> std::size_t top_dim,</div>
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno">   65</span>    std::vector&lt;Float_&gt;&amp; value_buffer,</div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span>    std::vector&lt;Float_&gt;&amp; stat_buffer)</div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno">   67</span>{</div>
<div class="line"><a id="l00082" name="l00082"></a><span class="lineno">   82</span>    <span class="keyword">const</span> <span class="keyword">auto</span> N = current.size();</div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno">   83</span>    <span class="keyword">auto</span> work = data.new_extractor(current.data(), <span class="keyword">static_cast&lt;</span>std::size_t<span class="keyword">&gt;</span>(N)); <span class="comment">// safety of the cast is already checked in InitializeVariancePartition::run(). </span></div>
<div class="line"><a id="l00084" name="l00084"></a><span class="lineno">   84</span>    value_buffer.clear();</div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno">   85</span>    value_buffer.reserve(N);</div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno">   86</span>    <span class="keywordflow">for</span> (<span class="keyword">decltype</span>(I(N)) i = 0; i &lt; N; ++i) {</div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno">   87</span>        <span class="keyword">const</span> <span class="keyword">auto</span> dptr = work-&gt;get_observation();</div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span>        value_buffer.push_back(dptr[top_dim]);</div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno">   89</span>    }</div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span>    std::sort(value_buffer.begin(), value_buffer.end());</div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno">   91</span> </div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno">   92</span>    <span class="comment">// stat_buffer[i] represents the SS when {0, 1, 2, ..., i} of values_buffer goes in the left partition and {i + 1, ..., N-1} goes in the right partition.</span></div>
<div class="line"><a id="l00093" name="l00093"></a><span class="lineno">   93</span>    <span class="comment">// This implies that stat_buffer will have length N - 1, such that i can span from 0 to N - 2.</span></div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno">   94</span>    <span class="comment">// It can also be guaranteed that N &gt;= 2 as a cluster with one point will have zero and thus never be selected for partition optimization. </span></div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno">   95</span>    stat_buffer.clear();</div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno">   96</span>    <span class="keyword">const</span> <span class="keyword">auto</span> N_m1 = N - 1;</div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno">   97</span>    stat_buffer.reserve(N_m1);</div>
<div class="line"><a id="l00098" name="l00098"></a><span class="lineno">   98</span> </div>
<div class="line"><a id="l00099" name="l00099"></a><span class="lineno">   99</span>    <span class="comment">// Forward and backward iterations to get the sum of squares for the left and right partitions, respectively, at every possible partition point.</span></div>
<div class="line"><a id="l00100" name="l00100"></a><span class="lineno">  100</span>    stat_buffer.push_back(0);</div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno">  101</span>    Float_ mean = value_buffer.front(), ss = 0, count = 2;</div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno">  102</span>    <span class="keywordflow">for</span> (<span class="keyword">decltype</span>(I(N_m1)) i = 1; i &lt; N_m1; ++i) { <span class="comment">// skip i == 0 as the left partition only has one point.</span></div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno">  103</span>        compute_welford&lt;Float_&gt;(value_buffer[i], mean, ss, count);</div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno">  104</span>        stat_buffer.push_back(ss);</div>
<div class="line"><a id="l00105" name="l00105"></a><span class="lineno">  105</span>        ++count;</div>
<div class="line"><a id="l00106" name="l00106"></a><span class="lineno">  106</span>    }</div>
<div class="line"><a id="l00107" name="l00107"></a><span class="lineno">  107</span> </div>
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno">  108</span>    mean = value_buffer.back(), ss = 0, count = 2;</div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno">  109</span>    <span class="keywordflow">for</span> (<span class="keyword">decltype</span>(I(N_m1)) i_p1 = N_m1 - 1; i_p1 &gt; 0; --i_p1) { <span class="comment">// skip i + 1 == N - 1 (i.e., i_p1 == N_m1) as the right partition only has one point. </span></div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span>        compute_welford&lt;Float_&gt;(value_buffer[i_p1], mean, ss, count);</div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno">  111</span>        stat_buffer[i_p1 - 1] += ss;</div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno">  112</span>        ++count;</div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span>    }</div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span> </div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno">  115</span>    <span class="comment">// iterator arithmetic is safe as we checked can_ptrdiff() in InitializeVariancePartition::run().</span></div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span>    <span class="keyword">const</span> <span class="keyword">auto</span> sbBegin = stat_buffer.begin(); </div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span>    <span class="keyword">const</span> <span class="keyword">decltype</span>(I(value_buffer.size())) which_min = std::min_element(sbBegin, stat_buffer.end()) - sbBegin;</div>
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno">  118</span> </div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span>    <span class="comment">// To avoid issues with ties, we use the average of the two edge points as the partition boundary.</span></div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span>    <span class="keyword">const</span> <span class="keyword">auto</span> left = value_buffer[which_min];</div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span>    <span class="keyword">const</span> <span class="keyword">auto</span> right = value_buffer[which_min + 1];</div>
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno">  122</span>    <span class="keywordflow">return</span> left + (right - left) / 2; <span class="comment">// avoid FP overflow.</span></div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span>}</div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span> </div>
<div class="line"><a id="l00125" name="l00125"></a><span class="lineno">  125</span>}</div>
<div class="line"><a id="l00165" name="l00165"></a><span class="lineno">  165</span><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Index_, <span class="keyword">typename</span> Data_, <span class="keyword">typename</span> Cluster_, <span class="keyword">typename</span> Float_, <span class="keyword">class</span> Matrix_ = Matrix&lt;Index_, Data_&gt; &gt;</div>
<div class="foldopen" id="foldopen00166" data-start="{" data-end="};">
<div class="line"><a id="l00166" name="l00166"></a><span class="lineno"><a class="line" href="classkmeans_1_1InitializeVariancePartition.html">  166</a></span><span class="keyword">class </span><a class="code hl_class" href="classkmeans_1_1InitializeVariancePartition.html">InitializeVariancePartition</a> final : <span class="keyword">public</span> <a class="code hl_class" href="classkmeans_1_1Initialize.html">Initialize</a>&lt;Index_, Data_, Cluster_, Float_, Matrix_&gt; {</div>
<div class="line"><a id="l00167" name="l00167"></a><span class="lineno">  167</span><span class="keyword">public</span>:</div>
<div class="line"><a id="l00171" name="l00171"></a><span class="lineno"><a class="line" href="classkmeans_1_1InitializeVariancePartition.html#af60562e2ec698603fc5d9bb8a803a2e5">  171</a></span>    <a class="code hl_function" href="classkmeans_1_1InitializeVariancePartition.html#af60562e2ec698603fc5d9bb8a803a2e5">InitializeVariancePartition</a>(<a class="code hl_struct" href="structkmeans_1_1InitializeVariancePartitionOptions.html">InitializeVariancePartitionOptions</a> options) : my_options(std::move(options)) {}</div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span> </div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno"><a class="line" href="classkmeans_1_1InitializeVariancePartition.html#a4606392ddcbcaa445808a3a522f0f214">  176</a></span>    <a class="code hl_function" href="classkmeans_1_1InitializeVariancePartition.html#a4606392ddcbcaa445808a3a522f0f214">InitializeVariancePartition</a>() = <span class="keywordflow">default</span>;</div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span> </div>
<div class="line"><a id="l00178" name="l00178"></a><span class="lineno">  178</span><span class="keyword">private</span>:</div>
<div class="line"><a id="l00179" name="l00179"></a><span class="lineno">  179</span>    <a class="code hl_struct" href="structkmeans_1_1InitializeVariancePartitionOptions.html">InitializeVariancePartitionOptions</a> my_options;</div>
<div class="line"><a id="l00180" name="l00180"></a><span class="lineno">  180</span> </div>
<div class="line"><a id="l00181" name="l00181"></a><span class="lineno">  181</span><span class="keyword">public</span>:</div>
<div class="foldopen" id="foldopen00186" data-start="{" data-end="}">
<div class="line"><a id="l00186" name="l00186"></a><span class="lineno"><a class="line" href="classkmeans_1_1InitializeVariancePartition.html#ae3512f5a3e3569a772eae2c0af255ca1">  186</a></span>    <a class="code hl_struct" href="structkmeans_1_1InitializeVariancePartitionOptions.html">InitializeVariancePartitionOptions</a>&amp; <a class="code hl_function" href="classkmeans_1_1InitializeVariancePartition.html#ae3512f5a3e3569a772eae2c0af255ca1">get_options</a>() {</div>
<div class="line"><a id="l00187" name="l00187"></a><span class="lineno">  187</span>        <span class="keywordflow">return</span> my_options;</div>
<div class="line"><a id="l00188" name="l00188"></a><span class="lineno">  188</span>    }</div>
</div>
<div class="line"><a id="l00189" name="l00189"></a><span class="lineno">  189</span> </div>
<div class="line"><a id="l00190" name="l00190"></a><span class="lineno">  190</span><span class="keyword">public</span>:</div>
<div class="line"><a id="l00194" name="l00194"></a><span class="lineno">  194</span>    Cluster_ <a class="code hl_function" href="classkmeans_1_1Initialize.html#a6a91bd58a95b69a775b70b7c526d3158">run</a>(<span class="keyword">const</span> Matrix_&amp; data, <span class="keyword">const</span> Cluster_ ncenters, Float_* <span class="keyword">const</span> centers)<span class="keyword"> const </span>{</div>
<div class="line"><a id="l00195" name="l00195"></a><span class="lineno">  195</span>        <span class="keyword">const</span> <span class="keyword">auto</span> nobs = data.num_observations();</div>
<div class="line"><a id="l00196" name="l00196"></a><span class="lineno">  196</span>        <span class="keyword">const</span> <span class="keyword">auto</span> ndim = data.num_dimensions();</div>
<div class="line"><a id="l00197" name="l00197"></a><span class="lineno">  197</span>        <span class="keywordflow">if</span> (nobs == 0 || ndim == 0) {</div>
<div class="line"><a id="l00198" name="l00198"></a><span class="lineno">  198</span>            <span class="keywordflow">return</span> 0;</div>
<div class="line"><a id="l00199" name="l00199"></a><span class="lineno">  199</span>        }</div>
<div class="line"><a id="l00200" name="l00200"></a><span class="lineno">  200</span> </div>
<div class="line"><a id="l00201" name="l00201"></a><span class="lineno">  201</span>        <span class="keyword">auto</span> assignments = sanisizer::create&lt;std::vector&lt;std::vector&lt;Index_&gt; &gt; &gt;(ncenters);</div>
<div class="line"><a id="l00202" name="l00202"></a><span class="lineno">  202</span>        sanisizer::resize(assignments[0], nobs);</div>
<div class="line"><a id="l00203" name="l00203"></a><span class="lineno">  203</span>        std::iota(assignments.front().begin(), assignments.front().end(), <span class="keyword">static_cast&lt;</span>Index_<span class="keyword">&gt;</span>(0));</div>
<div class="line"><a id="l00204" name="l00204"></a><span class="lineno">  204</span>        sanisizer::cast&lt;std::size_t&gt;(nobs); <span class="comment">// Checking that the maximum size of each &#39;assignments&#39; can fit into a std::size_t, for optimal_partition().</span></div>
<div class="line"><a id="l00205" name="l00205"></a><span class="lineno">  205</span> </div>
<div class="line"><a id="l00206" name="l00206"></a><span class="lineno">  206</span>        <span class="keyword">auto</span> dim_ss = sanisizer::create&lt;std::vector&lt;std::vector&lt;Float_&gt; &gt; &gt;(ncenters);</div>
<div class="line"><a id="l00207" name="l00207"></a><span class="lineno">  207</span>        {</div>
<div class="line"><a id="l00208" name="l00208"></a><span class="lineno">  208</span>            <span class="keyword">auto</span>&amp; cur_ss = dim_ss[0];</div>
<div class="line"><a id="l00209" name="l00209"></a><span class="lineno">  209</span>            sanisizer::resize(cur_ss, ndim);</div>
<div class="line"><a id="l00210" name="l00210"></a><span class="lineno">  210</span>            std::fill_n(centers, ndim, 0);</div>
<div class="line"><a id="l00211" name="l00211"></a><span class="lineno">  211</span>            <span class="keyword">auto</span> matwork = data.new_extractor(<span class="keyword">static_cast&lt;</span>Index_<span class="keyword">&gt;</span>(0), nobs);</div>
<div class="line"><a id="l00212" name="l00212"></a><span class="lineno">  212</span>            <span class="keywordflow">for</span> (<span class="keyword">decltype</span>(I(nobs)) i = 0; i &lt; nobs; ++i) {</div>
<div class="line"><a id="l00213" name="l00213"></a><span class="lineno">  213</span>                <span class="keyword">const</span> <span class="keyword">auto</span> dptr = matwork-&gt;get_observation();</div>
<div class="line"><a id="l00214" name="l00214"></a><span class="lineno">  214</span>                InitializeVariancePartition_internal::compute_welford(ndim, dptr, centers, cur_ss.data(), <span class="keyword">static_cast&lt;</span>Float_<span class="keyword">&gt;</span>(i + 1));</div>
<div class="line"><a id="l00215" name="l00215"></a><span class="lineno">  215</span>            }</div>
<div class="line"><a id="l00216" name="l00216"></a><span class="lineno">  216</span>        }</div>
<div class="line"><a id="l00217" name="l00217"></a><span class="lineno">  217</span> </div>
<div class="line"><a id="l00218" name="l00218"></a><span class="lineno">  218</span>        std::priority_queue&lt;std::pair&lt;Float_, Cluster_&gt; &gt; highest;</div>
<div class="line"><a id="l00219" name="l00219"></a><span class="lineno">  219</span>        <span class="keyword">auto</span> add_to_queue = [&amp;](<span class="keyword">const</span> Cluster_ i) -&gt; <span class="keywordtype">void</span> {</div>
<div class="line"><a id="l00220" name="l00220"></a><span class="lineno">  220</span>            <span class="keyword">const</span> <span class="keyword">auto</span>&amp; cur_ss = dim_ss[i];</div>
<div class="line"><a id="l00221" name="l00221"></a><span class="lineno">  221</span>            Float_ sum_ss = std::accumulate(cur_ss.begin(), cur_ss.end(), <span class="keyword">static_cast&lt;</span>Float_<span class="keyword">&gt;</span>(0));</div>
<div class="line"><a id="l00222" name="l00222"></a><span class="lineno">  222</span> </div>
<div class="line"><a id="l00223" name="l00223"></a><span class="lineno">  223</span>            <span class="comment">// Instead of dividing by N and then remultiplying by pow(N, adjustment), we just</span></div>
<div class="line"><a id="l00224" name="l00224"></a><span class="lineno">  224</span>            <span class="comment">// divide by pow(N, 1 - adjustment) to save some time and precision.</span></div>
<div class="line"><a id="l00225" name="l00225"></a><span class="lineno">  225</span>            sum_ss /= std::pow(assignments[i].size(), 1.0 - my_options.<a class="code hl_variable" href="structkmeans_1_1InitializeVariancePartitionOptions.html#a1fdbf82af2a33a26c4e58382797454c9">size_adjustment</a>);</div>
<div class="line"><a id="l00226" name="l00226"></a><span class="lineno">  226</span> </div>
<div class="line"><a id="l00227" name="l00227"></a><span class="lineno">  227</span>            highest.emplace(sum_ss, i);  </div>
<div class="line"><a id="l00228" name="l00228"></a><span class="lineno">  228</span>        };</div>
<div class="line"><a id="l00229" name="l00229"></a><span class="lineno">  229</span>        add_to_queue(0);</div>
<div class="line"><a id="l00230" name="l00230"></a><span class="lineno">  230</span> </div>
<div class="line"><a id="l00231" name="l00231"></a><span class="lineno">  231</span>        std::vector&lt;Index_&gt; cur_assignments_copy;</div>
<div class="line"><a id="l00232" name="l00232"></a><span class="lineno">  232</span>        std::vector&lt;Float_&gt; opt_partition_values, opt_partition_stats;</div>
<div class="line"><a id="l00233" name="l00233"></a><span class="lineno">  233</span> </div>
<div class="line"><a id="l00234" name="l00234"></a><span class="lineno">  234</span>        <span class="comment">// Checking that iterator arithmetic won&#39;t overflow the vector&#39;s ptrdiff type.</span></div>
<div class="line"><a id="l00235" name="l00235"></a><span class="lineno">  235</span>        sanisizer::can_ptrdiff&lt;<span class="keyword">decltype</span>(I(opt_partition_values.begin()))&gt;(nobs);</div>
<div class="line"><a id="l00236" name="l00236"></a><span class="lineno">  236</span>        sanisizer::can_ptrdiff&lt;<span class="keyword">decltype</span>(I(dim_ss.front().begin()))&gt;(ndim);</div>
<div class="line"><a id="l00237" name="l00237"></a><span class="lineno">  237</span> </div>
<div class="line"><a id="l00238" name="l00238"></a><span class="lineno">  238</span>        <span class="keywordflow">for</span> (Cluster_ cluster = 1; cluster &lt; ncenters; ++cluster) {</div>
<div class="line"><a id="l00239" name="l00239"></a><span class="lineno">  239</span>            <span class="keyword">const</span> <span class="keyword">auto</span> chosen = highest.top();</div>
<div class="line"><a id="l00240" name="l00240"></a><span class="lineno">  240</span>            <span class="keywordflow">if</span> (chosen.first == 0) {</div>
<div class="line"><a id="l00241" name="l00241"></a><span class="lineno">  241</span>                <span class="keywordflow">return</span> cluster; <span class="comment">// no point continuing, we&#39;re at zero variance already.</span></div>
<div class="line"><a id="l00242" name="l00242"></a><span class="lineno">  242</span>            }</div>
<div class="line"><a id="l00243" name="l00243"></a><span class="lineno">  243</span>            highest.pop();</div>
<div class="line"><a id="l00244" name="l00244"></a><span class="lineno">  244</span> </div>
<div class="line"><a id="l00245" name="l00245"></a><span class="lineno">  245</span>            <span class="keyword">const</span> <span class="keyword">auto</span> cur_center = centers + sanisizer::product_unsafe&lt;std::size_t&gt;(chosen.second, ndim);</div>
<div class="line"><a id="l00246" name="l00246"></a><span class="lineno">  246</span>            <span class="keyword">auto</span>&amp; cur_ss = dim_ss[chosen.second];</div>
<div class="line"><a id="l00247" name="l00247"></a><span class="lineno">  247</span>            <span class="keyword">auto</span>&amp; cur_assignments = assignments[chosen.second];</div>
<div class="line"><a id="l00248" name="l00248"></a><span class="lineno">  248</span> </div>
<div class="line"><a id="l00249" name="l00249"></a><span class="lineno">  249</span>            <span class="comment">// Iterator arithmetic is safe as we checked can_ptrdiff outside the loop.</span></div>
<div class="line"><a id="l00250" name="l00250"></a><span class="lineno">  250</span>            <span class="keyword">const</span> <span class="keyword">decltype</span>(I(ndim)) top_dim = std::max_element(cur_ss.begin(), cur_ss.end()) - cur_ss.begin();</div>
<div class="line"><a id="l00251" name="l00251"></a><span class="lineno">  251</span>            Float_ partition_boundary;</div>
<div class="line"><a id="l00252" name="l00252"></a><span class="lineno">  252</span>            <span class="keywordflow">if</span> (my_options.<a class="code hl_variable" href="structkmeans_1_1InitializeVariancePartitionOptions.html#a13e076c3b829ab3664a83a8f1d3b8bfc">optimize_partition</a>) {</div>
<div class="line"><a id="l00253" name="l00253"></a><span class="lineno">  253</span>                partition_boundary = InitializeVariancePartition_internal::optimize_partition(data, cur_assignments, top_dim, opt_partition_values, opt_partition_stats);</div>
<div class="line"><a id="l00254" name="l00254"></a><span class="lineno">  254</span>            } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00255" name="l00255"></a><span class="lineno">  255</span>                partition_boundary = cur_center[top_dim];</div>
<div class="line"><a id="l00256" name="l00256"></a><span class="lineno">  256</span>            }</div>
<div class="line"><a id="l00257" name="l00257"></a><span class="lineno">  257</span> </div>
<div class="line"><a id="l00258" name="l00258"></a><span class="lineno">  258</span>            <span class="keyword">const</span> <span class="keyword">auto</span> next_center = centers + sanisizer::product_unsafe&lt;std::size_t&gt;(cluster, ndim);</div>
<div class="line"><a id="l00259" name="l00259"></a><span class="lineno">  259</span>            std::fill_n(next_center, ndim, 0);</div>
<div class="line"><a id="l00260" name="l00260"></a><span class="lineno">  260</span>            <span class="keyword">auto</span>&amp; next_ss = dim_ss[cluster];</div>
<div class="line"><a id="l00261" name="l00261"></a><span class="lineno">  261</span>            next_ss.resize(ndim); <span class="comment">// resize() is safe from overflow as we already tested it outside the loop with dim_ss[0].</span></div>
<div class="line"><a id="l00262" name="l00262"></a><span class="lineno">  262</span>            <span class="keyword">auto</span>&amp; next_assignments = assignments[cluster];</div>
<div class="line"><a id="l00263" name="l00263"></a><span class="lineno">  263</span> </div>
<div class="line"><a id="l00264" name="l00264"></a><span class="lineno">  264</span>            cur_assignments_copy.clear();</div>
<div class="line"><a id="l00265" name="l00265"></a><span class="lineno">  265</span>            std::fill_n(cur_center, ndim, 0);</div>
<div class="line"><a id="l00266" name="l00266"></a><span class="lineno">  266</span>            std::fill(cur_ss.begin(), cur_ss.end(), 0);</div>
<div class="line"><a id="l00267" name="l00267"></a><span class="lineno">  267</span>            <span class="keyword">auto</span> work = data.new_extractor(cur_assignments.data(), cur_assignments.size());</div>
<div class="line"><a id="l00268" name="l00268"></a><span class="lineno">  268</span> </div>
<div class="line"><a id="l00269" name="l00269"></a><span class="lineno">  269</span>            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> i : cur_assignments) {</div>
<div class="line"><a id="l00270" name="l00270"></a><span class="lineno">  270</span>                <span class="keyword">const</span> <span class="keyword">auto</span> dptr = work-&gt;get_observation(); <span class="comment">// make sure this is outside the if(), as it must always be called in each loop iteration to match &#39;cur_assignments&#39; properly.</span></div>
<div class="line"><a id="l00271" name="l00271"></a><span class="lineno">  271</span>                <span class="keywordflow">if</span> (dptr[top_dim] &lt; partition_boundary) {</div>
<div class="line"><a id="l00272" name="l00272"></a><span class="lineno">  272</span>                    cur_assignments_copy.push_back(i);</div>
<div class="line"><a id="l00273" name="l00273"></a><span class="lineno">  273</span>                    InitializeVariancePartition_internal::compute_welford(ndim, dptr, cur_center, cur_ss.data(), <span class="keyword">static_cast&lt;</span>Float_<span class="keyword">&gt;</span>(cur_assignments_copy.size()));</div>
<div class="line"><a id="l00274" name="l00274"></a><span class="lineno">  274</span>                } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00275" name="l00275"></a><span class="lineno">  275</span>                    next_assignments.push_back(i);</div>
<div class="line"><a id="l00276" name="l00276"></a><span class="lineno">  276</span>                    InitializeVariancePartition_internal::compute_welford(ndim, dptr, next_center, next_ss.data(), <span class="keyword">static_cast&lt;</span>Float_<span class="keyword">&gt;</span>(next_assignments.size()));</div>
<div class="line"><a id="l00277" name="l00277"></a><span class="lineno">  277</span>                }</div>
<div class="line"><a id="l00278" name="l00278"></a><span class="lineno">  278</span>            }</div>
<div class="line"><a id="l00279" name="l00279"></a><span class="lineno">  279</span> </div>
<div class="line"><a id="l00280" name="l00280"></a><span class="lineno">  280</span>            <span class="comment">// If one or the other is empty, then this entire procedure short-circuits as all future iterations will just re-select this cluster (which won&#39;t get partitioned properly anyway).</span></div>
<div class="line"><a id="l00281" name="l00281"></a><span class="lineno">  281</span>            <span class="comment">// In the bigger picture, the quick exit out of the iterations is correct as we should only fail to partition in this manner if all points within each remaining cluster are identical.</span></div>
<div class="line"><a id="l00282" name="l00282"></a><span class="lineno">  282</span>            <span class="keywordflow">if</span> (next_assignments.empty() || cur_assignments_copy.empty()) {</div>
<div class="line"><a id="l00283" name="l00283"></a><span class="lineno">  283</span>                <span class="keywordflow">return</span> cluster;</div>
<div class="line"><a id="l00284" name="l00284"></a><span class="lineno">  284</span>            }</div>
<div class="line"><a id="l00285" name="l00285"></a><span class="lineno">  285</span> </div>
<div class="line"><a id="l00286" name="l00286"></a><span class="lineno">  286</span>            cur_assignments.swap(cur_assignments_copy);</div>
<div class="line"><a id="l00287" name="l00287"></a><span class="lineno">  287</span>            add_to_queue(chosen.second);</div>
<div class="line"><a id="l00288" name="l00288"></a><span class="lineno">  288</span>            add_to_queue(cluster);</div>
<div class="line"><a id="l00289" name="l00289"></a><span class="lineno">  289</span>        }</div>
<div class="line"><a id="l00290" name="l00290"></a><span class="lineno">  290</span> </div>
<div class="line"><a id="l00291" name="l00291"></a><span class="lineno">  291</span>        <span class="keywordflow">return</span> ncenters;</div>
<div class="line"><a id="l00292" name="l00292"></a><span class="lineno">  292</span>    }</div>
<div class="line"><a id="l00296" name="l00296"></a><span class="lineno">  296</span>};</div>
</div>
<div class="line"><a id="l00297" name="l00297"></a><span class="lineno">  297</span> </div>
<div class="line"><a id="l00298" name="l00298"></a><span class="lineno">  298</span>}</div>
<div class="line"><a id="l00299" name="l00299"></a><span class="lineno">  299</span> </div>
<div class="line"><a id="l00300" name="l00300"></a><span class="lineno">  300</span><span class="preprocessor">#endif</span></div>
<div class="ttc" id="aInitialize_8hpp_html"><div class="ttname"><a href="Initialize_8hpp.html">Initialize.hpp</a></div><div class="ttdoc">Interface for k-means initialization.</div></div>
<div class="ttc" id="aMatrix_8hpp_html"><div class="ttname"><a href="Matrix_8hpp.html">Matrix.hpp</a></div><div class="ttdoc">Interface for matrix inputs.</div></div>
<div class="ttc" id="aclasskmeans_1_1InitializeVariancePartition_html"><div class="ttname"><a href="classkmeans_1_1InitializeVariancePartition.html">kmeans::InitializeVariancePartition</a></div><div class="ttdoc">Implements the variance partitioning method of Su and Dy (2007).</div><div class="ttdef"><b>Definition</b> InitializeVariancePartition.hpp:166</div></div>
<div class="ttc" id="aclasskmeans_1_1InitializeVariancePartition_html_a4606392ddcbcaa445808a3a522f0f214"><div class="ttname"><a href="classkmeans_1_1InitializeVariancePartition.html#a4606392ddcbcaa445808a3a522f0f214">kmeans::InitializeVariancePartition::InitializeVariancePartition</a></div><div class="ttdeci">InitializeVariancePartition()=default</div></div>
<div class="ttc" id="aclasskmeans_1_1InitializeVariancePartition_html_ae3512f5a3e3569a772eae2c0af255ca1"><div class="ttname"><a href="classkmeans_1_1InitializeVariancePartition.html#ae3512f5a3e3569a772eae2c0af255ca1">kmeans::InitializeVariancePartition::get_options</a></div><div class="ttdeci">InitializeVariancePartitionOptions &amp; get_options()</div><div class="ttdef"><b>Definition</b> InitializeVariancePartition.hpp:186</div></div>
<div class="ttc" id="aclasskmeans_1_1InitializeVariancePartition_html_af60562e2ec698603fc5d9bb8a803a2e5"><div class="ttname"><a href="classkmeans_1_1InitializeVariancePartition.html#af60562e2ec698603fc5d9bb8a803a2e5">kmeans::InitializeVariancePartition::InitializeVariancePartition</a></div><div class="ttdeci">InitializeVariancePartition(InitializeVariancePartitionOptions options)</div><div class="ttdef"><b>Definition</b> InitializeVariancePartition.hpp:171</div></div>
<div class="ttc" id="aclasskmeans_1_1Initialize_html"><div class="ttname"><a href="classkmeans_1_1Initialize.html">kmeans::Initialize</a></div><div class="ttdoc">Interface for k-means initialization algorithms.</div><div class="ttdef"><b>Definition</b> Initialize.hpp:29</div></div>
<div class="ttc" id="aclasskmeans_1_1Initialize_html_a6a91bd58a95b69a775b70b7c526d3158"><div class="ttname"><a href="classkmeans_1_1Initialize.html#a6a91bd58a95b69a775b70b7c526d3158">kmeans::Initialize::run</a></div><div class="ttdeci">virtual Cluster_ run(const Matrix_ &amp;data, Cluster_ num_centers, Float_ *centers) const =0</div></div>
<div class="ttc" id="anamespacekmeans_html"><div class="ttname"><a href="namespacekmeans.html">kmeans</a></div><div class="ttdoc">Namespace for k-means clustering.</div><div class="ttdef"><b>Definition</b> compute_wcss.hpp:16</div></div>
<div class="ttc" id="astructkmeans_1_1InitializeVariancePartitionOptions_html"><div class="ttname"><a href="structkmeans_1_1InitializeVariancePartitionOptions.html">kmeans::InitializeVariancePartitionOptions</a></div><div class="ttdoc">Options for InitializeVariancePartition.</div><div class="ttdef"><b>Definition</b> InitializeVariancePartition.hpp:25</div></div>
<div class="ttc" id="astructkmeans_1_1InitializeVariancePartitionOptions_html_a13e076c3b829ab3664a83a8f1d3b8bfc"><div class="ttname"><a href="structkmeans_1_1InitializeVariancePartitionOptions.html#a13e076c3b829ab3664a83a8f1d3b8bfc">kmeans::InitializeVariancePartitionOptions::optimize_partition</a></div><div class="ttdeci">bool optimize_partition</div><div class="ttdef"><b>Definition</b> InitializeVariancePartition.hpp:36</div></div>
<div class="ttc" id="astructkmeans_1_1InitializeVariancePartitionOptions_html_a1fdbf82af2a33a26c4e58382797454c9"><div class="ttname"><a href="structkmeans_1_1InitializeVariancePartitionOptions.html#a1fdbf82af2a33a26c4e58382797454c9">kmeans::InitializeVariancePartitionOptions::size_adjustment</a></div><div class="ttdeci">double size_adjustment</div><div class="ttdef"><b>Definition</b> InitializeVariancePartition.hpp:30</div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
